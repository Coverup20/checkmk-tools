================================================================================
ELENCO DETTAGLIATO SCRIPT NETHSERVER 8
Repository: checkmk-tools
Cartella: script-check-ns8/
Data: 27 Ottobre 2025
================================================================================

ğŸ“ STRUTTURA CARTELLE
â”œâ”€â”€ nopolling/          (5 script: 2 principali + 2 wrapper remoti + 1 readme)
â””â”€â”€ polling/            (11 script: 5 principali + 5 wrapper remoti + 1 readme)

================================================================================
ğŸ“‚ SCRIPT-CHECK-NS8/NOPOLLING/
================================================================================

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
CATEGORIA: SOS (SUPPORTO REMOTO)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. check-sos.sh
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Righe:         40
Service:       SOS_session
Path Install:  /usr/local/bin/

DESCRIZIONE:
Monitora lo stato della sessione SOS (NethSecurity Support) leggendo 
/var/log/messages per rilevare eventi start/stop della sessione.

FUNZIONALITÃ€:
âœ“ Legge eventi start-support-session e stop-support-session dai log
âœ“ Estrae Session ID dal messaggio "Transmit the following session ID"
âœ“ Determina se sessione Ã¨ ACTIVE o INACTIVE confrontando timestamp
âœ“ Mostra Session ID quando disponibile

STATI:
0 (OK)   - SOS Session INACTIVE
1 (WARN) - SOS Session ACTIVE (sessione supporto attiva)

FILE UTILIZZATI:
- Log: /var/log/messages

PATTERN RICERCATI:
- "start-support-session"
- "stop-support-session"
- "Transmit the following session ID"

LOGICA:
- Se ultima riga start Ã¨ piÃ¹ recente di ultima riga stop â†’ ACTIVE
- Se non c'Ã¨ stop o start Ã¨ successivo â†’ ACTIVE
- Altrimenti â†’ INACTIVE

ESEMPIO OUTPUT:
"0 SOS_session - SOS Session: INACTIVE (ID: N/A)"
"1 SOS_session - SOS Session: ACTIVE (ID: 987654321)"


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
CATEGORIA: MONITORAGGIO PODMAN
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

2. monitor_podman_events.sh
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Righe:         21 (ripetuto 3 volte nel file)
Service:       (demone background - nessun output CheckMK)
Path Install:  /usr/local/bin/
Tipo:          Demone di logging eventi

DESCRIZIONE:
Demone che ascolta continuamente gli eventi Podman e registra solo gli eventi
significativi (create, start, stop, remove) escludendo i container Redis.

FUNZIONALITÃ€:
âœ“ Ascolta eventi Podman in real-time (podman events)
âœ“ Filtra solo eventi tipo container
âœ“ Registra solo eventi: create, start, stop, remove
âœ“ Esclude automaticamente container "redis"
âœ“ Formatta eventi con timestamp, status, nome, ID

FILE UTILIZZATI:
- Log output: /var/log/podman_events.log

COMANDI USATI:
- podman events --filter type=container

FORMATO LOG:
YYYY-MM-DD HH:MM:SS - TIMESTAMP STATUS NOME (CONTAINERID)

UTILIZZO:
Deve essere eseguito come servizio systemd o in background.
Fornisce il log che viene poi letto da check_podman_events.sh (polling).

ESEMPIO LOG:
2025-10-27 14:30:15 - 2025-10-27T14:30:15.123456+00:00 start webtop1 (abc123def456)
2025-10-27 14:32:20 - 2025-10-27T14:32:20.789012+00:00 stop mail1 (def789ghi012)

NOTE:
âš ï¸ Script demone - non genera output CheckMK
âš ï¸ Richiede esecuzione continua in background
âš ï¸ Il file contiene codice duplicato (3 copie identiche)


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
3. rcheck-sos.sh
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
DESCRIZIONE:
Wrapper remoto per check-sos.sh

SCRIPT_URL:
https://raw.githubusercontent.com/Coverup20/checkmk-tools/main/script-check-ns8/nopolling/check-sos.sh

Path Install: /usr/local/bin/


4. rmonitor_podman_events.sh
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
DESCRIZIONE:
Wrapper remoto per monitor_podman_events.sh

SCRIPT_URL:
https://raw.githubusercontent.com/Coverup20/checkmk-tools/main/script-check-ns8/nopolling/monitor_podman_events.sh

Path Install: /usr/local/bin/


5. readme.txt
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
CONTENUTO:
"vanno messi qua /usr/local/bin/"

NOTA:
Gli script nopolling di NS8 NON vanno in /usr/lib/check_mk_agent/local/
ma in /usr/local/bin/ perchÃ© sono utility e demoni di sistema.


================================================================================
ğŸ“‚ SCRIPT-CHECK-NS8/POLLING/
================================================================================

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
CATEGORIA: CONTAINER & ISTANZE NS8
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. check_ns8_containers.sh
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Righe:         64
Service:       Multipli (uno per istanza)
Path Install:  /usr/lib/check_mk_agent/local/

DESCRIZIONE:
Monitoraggio completo delle istanze NethServer 8 tramite comando runagent.
Controlla stato, risorse CPU/RAM di ogni istanza con nomi friendly.

FUNZIONALITÃ€:
âœ“ Elenca tutte le istanze NS8 (esclusi cluster e node)
âœ“ Mappa nomi tecnici a nomi friendly (es: ldapproxy1 â†’ LdapProxy)
âœ“ Verifica se istanza Ã¨ attiva (runagent -m test)
âœ“ Estrae statistiche container (CPU%, RAM usage, RAM%)
âœ“ Per istanza Mail: conta sessioni IMAP attive con doveadm

MAPPING NOMI FRIENDLY:
ldapproxy â†’ LdapProxy
openldap â†’ OpenLDAP
webtop â†’ WebTop
nextcloud â†’ Nextcloud
nethvoice â†’ NethVoice
traefik â†’ Traefik
mail â†’ Mail
samba â†’ Samba
mattermost â†’ Mattermost
metrics â†’ Metrics
loki â†’ Loki
nethsecurity â†’ NethSecurity

STATI:
0 (OK)   - Istanza/servizio attivo
1 (WARN) - Nessuna sessione IMAP (solo per Mail)
2 (CRIT) - Istanza non attiva

COMANDI USATI:
- runagent -l (lista istanze)
- runagent -m ISTANZA true (test istanza)
- runagent -m ISTANZA podman stats (statistiche container)
- runagent -m ISTANZA doveadm who (sessioni IMAP)

SERVIZI GENERATI PER OGNI ISTANZA:
- {Nome}           (stato istanza)
- {Nome}_CPU       (utilizzo CPU)
- {Nome}_RAM       (utilizzo RAM)
- Mail_IMAP        (solo per istanza Mail: sessioni attive)

ESEMPIO OUTPUT:
"0 WebTop - WebTop attivo"
"0 WebTop_CPU - CPU 15.2%"
"0 WebTop_RAM - RAM 512MiB (25.6%)"
"0 Mail - Mail attivo"
"0 Mail_CPU - CPU 8.5%"
"0 Mail_RAM - RAM 1.2GiB (12.3%)"
"0 Mail_IMAP - Sessioni IMAP attive: 5"


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
CATEGORIA: SERVIZI MAIL
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

2. check_ns8_services.sh
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Righe:         73
Service:       clamav, rspamd, dovecot, postfix, imap_sessions, dovecot_vszlimit
Path Install:  /usr/lib/check_mk_agent/local/

DESCRIZIONE:
Controllo approfondito dei servizi mail di NethServer 8.
Monitora container interni (ClamAV, Rspamd, Dovecot, Postfix) e problemi 
specifici come vsz_limit di Dovecot.

FUNZIONALITÃ€:
âœ“ Rileva tutte le istanze mail (mail1, mail2, ...)
âœ“ Verifica stato container: clamav, rspamd, dovecot, postfix
âœ“ Conta sessioni IMAP attive (doveadm who)
âœ“ Legge configurazione VszLimit da config show dovecot
âœ“ Scansiona log Dovecot per errori "Cannot allocate memory due to vsz_limit"
âœ“ Conta occorrenze vsz_limit nelle ultime 500 righe di log

CONFIGURAZIONE:
LOG_LINES=500  (righe di log da analizzare)

TARGET_SERVICES:
- clamav   (antivirus)
- rspamd   (antispam)
- dovecot  (IMAP/POP3)
- postfix  (SMTP)

STATI:
0 (OK)   - Servizio attivo, nessun problema
1 (WARN) - Nessuna sessione IMAP o VszLimit non impostato
2 (CRIT) - Servizio non attivo o vsz_limit rilevato nei log
3 (UNKNOWN) - Servizio non trovato

COMANDI USATI:
- runagent -l | grep '^mail'
- runagent -m MAIL podman ps
- runagent -m MAIL podman exec dovecot doveadm who
- config show dovecot
- runagent -m MAIL podman exec dovecot tail -n 500 /var/log/dovecot*

SERVIZI GENERATI:
- clamav
- rspamd
- dovecot
- postfix
- imap_sessions
- dovecot_vszlimit

ESEMPIO OUTPUT:
"0 clamav - clamav attivo"
"0 rspamd - rspamd attivo"
"0 dovecot - dovecot attivo"
"0 postfix - postfix attivo"
"0 imap_sessions - Sessioni IMAP attive: 8"
"0 dovecot_vszlimit - Nessun allarme nei log (limite configurato=512M)"
"2 dovecot_vszlimit - CRIT: rilevato vsz_limit (3 occorrenze nelle ultime 500 righe, limite configurato=256M)"


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
CATEGORIA: TOMCAT & JAVA
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

3. check_ns8_tomcat8.sh
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Righe:         45
Service:       Tomcat8
Path Install:  /usr/lib/check_mk_agent/local/

DESCRIZIONE:
Monitora processo Tomcat8 all'interno dei container NS8.
Controlla utilizzo memoria RAM e uptime con soglie configurabili.

FUNZIONALITÃ€:
âœ“ Cerca processo Tomcat (org.apache.catalina.startup.Bootstrap) in tutti i container
âœ“ Misura memoria RSS del processo in MB
âœ“ Calcola uptime del processo
âœ“ Applica soglie WARN/CRIT su utilizzo memoria

CONFIGURAZIONE SOGLIE:
WARN=1024   (warning se memoria â‰¥ 1024MB)
CRIT=1536   (critical se memoria â‰¥ 1536MB)

STATI:
0 (OK)   - Memoria sotto soglia WARN
1 (WARN) - Memoria â‰¥ 1024MB
2 (CRIT) - Memoria â‰¥ 1536MB o Tomcat non attivo

COMANDI USATI:
- runagent -l
- runagent -m ISTANZA podman ps
- runagent -m ISTANZA podman exec CONTAINER pgrep -f "org.apache.catalina"
- runagent -m ISTANZA podman exec CONTAINER ps -o rss= -p PID
- runagent -m ISTANZA podman exec CONTAINER ps -o etime= -p PID

ESEMPIO OUTPUT:
"0 Tomcat8 - Tomcat8 OK - Memoria=856MB; Uptime=3-15:42:10"
"1 Tomcat8 - Tomcat8 WARN - Memoria=1150MB (>1024MB); Uptime=1-08:20:05"
"2 Tomcat8 - Tomcat8 CRIT - Memoria=1620MB (>1536MB); Uptime=10:15:30"
"2 Tomcat8 - NON attivo"


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
CATEGORIA: WEBTOP
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

4. check_ns8_webtop.sh
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Righe:         37
Service:       Webtop5
Path Install:  /usr/lib/check_mk_agent/local/

DESCRIZIONE:
Monitora WebTop in NethServer 8 verificando presenza istanza e raggiungibilitÃ 
interfaccia web tramite HTTP/HTTPS.

FUNZIONALITÃ€:
âœ“ Estrae dominio da FQDN (hostname -f)
âœ“ Cerca istanze WebTop con runagent
âœ“ Testa raggiungibilitÃ  URL https://webtop.DOMINIO/webtop/
âœ“ Verifica codice HTTP di risposta

STATI:
0 (OK)   - WebTop risponde con HTTP 200
2 (CRIT) - Nessuna istanza trovata, dominio non rilevato, o HTTP != 200

COMANDI USATI:
- hostname -f
- runagent -l | grep '^webtop'
- curl -sk -o /dev/null -w "%{http_code}" URL

URL TESTATO:
https://webtop.{DOMINIO}/webtop/

ESEMPIO OUTPUT:
"0 Webtop5 - WebTop risponde su https://webtop.example.com/webtop/ (HTTP 200)"
"2 Webtop5 - WebTop NON risponde su https://webtop.example.com/webtop/ (HTTP 503)"
"2 Webtop5 - Nessuna istanza WebTop trovata"
"2 Webtop5 - Nessun dominio rilevato da hostname -f"


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
CATEGORIA: EVENTI PODMAN
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

5. check_podman_events.sh
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Righe:         28
Service:       Podman_Status
Path Install:  /usr/lib/check_mk_agent/local/

DESCRIZIONE:
Legge il log degli eventi Podman (generato da monitor_podman_events.sh)
e mostra l'ultimo evento significativo degli ultimi 5 minuti.

FUNZIONALITÃ€:
âœ“ Legge /var/log/podman_events.log
âœ“ Filtra eventi degli ultimi 5 minuti
âœ“ Esclude eventi container "redis"
âœ“ Filtra solo eventi: create, start, stop, remove
âœ“ Mostra ultimo evento (Nome container + Azione)

CONFIGURAZIONE:
RECENT="5 minutes ago"  (finestra temporale)

STATI:
0 (OK)   - Nessun evento negli ultimi 5 minuti
1 (WARN) - Evento rilevato (notifica cambiamento stato container)

FILE UTILIZZATI:
- Log input: /var/log/podman_events.log

LOGICA:
- Filtra righe con timestamp > (now - 5 minuti)
- Esclude "redis"
- Cerca solo create|start|stop|remove
- Prende ultima riga
- Estrae Nome (campo 6) e Azione (campo 5)
- Capitalizza prima lettera

ESEMPIO OUTPUT:
"0 Podman_Status - Nessun Evento"
"1 Podman_Status - Webtop1 Start"
"1 Podman_Status - Mail1 Stop"
"1 Podman_Status - Traefik Create"

DIPENDENZE:
âš ï¸ Richiede monitor_podman_events.sh attivo in background
âš ï¸ Richiede /var/log/podman_events.log popolato


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
SCRIPT REMOTI (WRAPPER) - POLLING
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

6. rcheck_ns8_containers.sh
7. rcheck_ns8_services.sh
8. rcheck_ns8_tomcat8.sh
9. rcheck_ns8_webtop.sh
10. rcheck_podman_events.sh

FUNZIONAMENTO:
bash <(curl -fsSL "$SCRIPT_URL") "$@"

SCRIPT_URL BASE:
https://raw.githubusercontent.com/Coverup20/checkmk-tools/main/script-check-ns8/polling/

Path Install: /usr/lib/check_mk_agent/local/


11. readme.txt
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
CONTENUTO:
"vanno messi qua /usr/lib/check_mk_agent/local"

NOTA:
Gli script polling di NS8 vanno in /usr/lib/check_mk_agent/local/
(non in plugins/ come altri sistemi).


================================================================================
RIEPILOGO FUNZIONALITÃ€
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CATEGORIA                â”‚ SCRIPT                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SOS Support              â”‚ check-sos.sh                                   â”‚
â”‚                          â”‚ rcheck-sos.sh                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Podman Events Daemon     â”‚ monitor_podman_events.sh                       â”‚
â”‚                          â”‚ rmonitor_podman_events.sh                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Container Monitoring     â”‚ check_ns8_containers.sh                        â”‚
â”‚                          â”‚ rcheck_ns8_containers.sh                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Mail Services            â”‚ check_ns8_services.sh                          â”‚
â”‚                          â”‚ rcheck_ns8_services.sh                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Tomcat Monitoring        â”‚ check_ns8_tomcat8.sh                           â”‚
â”‚                          â”‚ rcheck_ns8_tomcat8.sh                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ WebTop Monitoring        â”‚ check_ns8_webtop.sh                            â”‚
â”‚                          â”‚ rcheck_ns8_webtop.sh                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Podman Events Check      â”‚ check_podman_events.sh                         â”‚
â”‚                          â”‚ rcheck_podman_events.sh                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
DIPENDENZE
================================================================================

RICHIESTE:
âœ“ NethServer 8 (basato su Podman)
âœ“ CheckMK Raw 2.4.x
âœ“ bash
âœ“ curl (per script remoti)
âœ“ runagent (comando NS8 per gestione istanze)
âœ“ podman (container runtime)

COMANDI NETHSERVER 8 SPECIFICI:
- runagent -l                    (lista istanze)
- runagent -m ISTANZA comando    (esegue comando in istanza)
- config show SERVICE            (configurazione NS8)

COMANDI PODMAN:
- podman events                  (stream eventi)
- podman ps                      (lista container)
- podman exec                    (esegui comando in container)
- podman stats                   (statistiche risorse)

SERVIZI MONITORATI:
- SOS (supporto remoto NethSecurity)
- Istanze NS8: LdapProxy, OpenLDAP, WebTop, Nextcloud, NethVoice, Traefik, Mail, Samba, Mattermost, Metrics, Loki
- Mail services: ClamAV, Rspamd, Dovecot, Postfix
- Tomcat8 (per WebTop)


================================================================================
ARCHITETTURA NETHSERVER 8
================================================================================

CONCETTI CHIAVE:
NethServer 8 usa un'architettura basata su istanze modulari containerizzate.

ISTANZE:
Ogni applicazione (Mail, WebTop, Nextcloud, ecc.) gira in una "istanza"
che contiene uno o piÃ¹ container Podman.

RUNAGENT:
Comando NS8 per interagire con le istanze:
- runagent -l                    â†’ Lista tutte le istanze
- runagent -m mail1 comando      â†’ Esegue comando dentro istanza mail1

CONTAINER INTERNI:
Ogni istanza mail contiene container separati:
- clamav    (antivirus)
- rspamd    (antispam)
- dovecot   (IMAP/POP3)
- postfix   (SMTP)

ESEMPIO GERARCHIA:
NethServer 8 Host
â”œâ”€â”€ Istanza: mail1
â”‚   â”œâ”€â”€ Container: clamav
â”‚   â”œâ”€â”€ Container: rspamd
â”‚   â”œâ”€â”€ Container: dovecot
â”‚   â””â”€â”€ Container: postfix
â”œâ”€â”€ Istanza: webtop1
â”‚   â””â”€â”€ Container: tomcat8
â””â”€â”€ Istanza: traefik1
    â””â”€â”€ Container: traefik


================================================================================
UTILIZZO SCRIPT LOCALI
================================================================================

INSTALLAZIONE NOPOLLING (/usr/local/bin/):
1. Copiare script in /usr/local/bin/
2. Rendere eseguibile: chmod +x /usr/local/bin/nome_script.sh
3. Per monitor_podman_events.sh: creare servizio systemd

ESEMPIO NOPOLLING:
cp check-sos.sh /usr/local/bin/
chmod +x /usr/local/bin/check-sos.sh

SERVIZIO SYSTEMD PER MONITOR PODMAN:
File: /etc/systemd/system/podman-events-monitor.service

[Unit]
Description=Podman Events Monitor
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/monitor_podman_events.sh
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target

Abilitare:
systemctl enable --now podman-events-monitor.service


INSTALLAZIONE POLLING (/usr/lib/check_mk_agent/local/):
1. Copiare script in /usr/lib/check_mk_agent/local/
2. Rendere eseguibile: chmod +x nome_script.sh
3. Eseguire service discovery in CheckMK

ESEMPIO POLLING:
cp check_ns8_containers.sh /usr/lib/check_mk_agent/local/
chmod +x /usr/lib/check_mk_agent/local/check_ns8_containers.sh


================================================================================
UTILIZZO SCRIPT REMOTI
================================================================================

INSTALLAZIONE:
1. Copiare wrapper remoto (rNOME.sh) nella directory appropriata
2. Rendere eseguibile: chmod +x rNOME.sh
3. Lo script scaricherÃ  automaticamente l'ultima versione da GitHub

ESEMPIO NOPOLLING (in /usr/local/bin/):
cp rcheck-sos.sh /usr/local/bin/
chmod +x /usr/local/bin/rcheck-sos.sh

ESEMPIO POLLING (in /usr/lib/check_mk_agent/local/):
cp rcheck_ns8_containers.sh /usr/lib/check_mk_agent/local/
chmod +x /usr/lib/check_mk_agent/local/rcheck_ns8_containers.sh

VANTAGGI:
âœ“ Aggiornamenti automatici dal repository
âœ“ No manutenzione manuale degli script
âœ“ Centralized management


================================================================================
NOTE AGGIUNTIVE
================================================================================

FORMATO OUTPUT CHECKMK:
Tutti gli script seguono il formato CheckMK local check:
<<<local>>>
STATO NOME_SERVIZIO - DETTAGLI [| METRICHE]

STATI:
0 = OK
1 = WARNING
2 = CRITICAL
3 = UNKNOWN

DIFFERENZA PATH INSTALLAZIONE:
- NOPOLLING NS8: /usr/local/bin/ (utility di sistema)
- POLLING NS8: /usr/lib/check_mk_agent/local/ (check CheckMK)

NOTA: A differenza di NS7, gli script polling NS8 vanno in local/ non in plugins/

BEST PRACTICES:
- Avviare monitor_podman_events.sh come servizio systemd
- Usare check_ns8_containers.sh per overview generale istanze
- Usare check_ns8_services.sh per monitoraggio approfondito mail
- Monitorare vsz_limit di Dovecot (problema comune NS8)
- Configurare soglie Tomcat in base a RAM disponibile


================================================================================
FILE DI LOG
================================================================================

SCRIPT CON LOG CUSTOM:
monitor_podman_events.sh       â†’ /var/log/podman_events.log (scrive)
check_podman_events.sh         â†’ /var/log/podman_events.log (legge)

LOG DI SISTEMA LETTI:
/var/log/messages              (SOS session)
/var/log/dovecot*              (vsz_limit errors - dentro container)


================================================================================
ESEMPI DI OUTPUT COMPLETI
================================================================================

SOS:
0 SOS_session - SOS Session: INACTIVE (ID: N/A)
1 SOS_session - SOS Session: ACTIVE (ID: 123456789)

CONTAINERS:
0 WebTop - WebTop attivo
0 WebTop_CPU - CPU 12.5%
0 WebTop_RAM - RAM 768MiB (38.4%)
0 Mail - Mail attivo
0 Mail_CPU - CPU 5.2%
0 Mail_RAM - RAM 1.5GiB (15.0%)
0 Mail_IMAP - Sessioni IMAP attive: 12

MAIL SERVICES:
0 clamav - clamav attivo
0 rspamd - rspamd attivo
0 dovecot - dovecot attivo
0 postfix - postfix attivo
0 imap_sessions - Sessioni IMAP attive: 8
0 dovecot_vszlimit - Nessun allarme nei log (limite configurato=512M)

TOMCAT:
0 Tomcat8 - Tomcat8 OK - Memoria=945MB; Uptime=5-12:30:15
1 Tomcat8 - Tomcat8 WARN - Memoria=1100MB (>1024MB); Uptime=2-08:15:42

WEBTOP:
0 Webtop5 - WebTop risponde su https://webtop.example.com/webtop/ (HTTP 200)

PODMAN EVENTS:
0 Podman_Status - Nessun Evento
1 Podman_Status - Traefik Start


================================================================================
TROUBLESHOOTING
================================================================================

PROBLEMA: runagent command not found
SOLUZIONE:
- Verificare di essere su NethServer 8
- runagent Ã¨ specifico di NS8, non disponibile su NS7

PROBLEMA: Podman_Status sempre "Nessun Evento"
SOLUZIONE:
- Verificare che monitor_podman_events.sh sia in esecuzione
- Controllare log: tail -f /var/log/podman_events.log
- Verificare servizio systemd: systemctl status podman-events-monitor

PROBLEMA: check_ns8_services.sh non trova istanze mail
SOLUZIONE:
- Verificare istanze: runagent -l | grep mail
- Testare manualmente: runagent -m mail1 true

PROBLEMA: dovecot_vszlimit sempre CRIT
SOLUZIONE:
- Aumentare VszLimit: config setprop dovecot VszLimit 1024
- Riavviare dovecot: runagent -m mail1 systemctl restart dovecot
- Verificare configurazione: config show dovecot

PROBLEMA: Script remoto non funziona
SOLUZIONE:
- Verificare connettivitÃ  GitHub: curl -I https://raw.githubusercontent.com
- Controllare firewall NS8
- Testare URL manualmente: curl -fsSL "$SCRIPT_URL"

PROBLEMA: Tomcat8 non trovato
SOLUZIONE:
- Verificare istanze WebTop: runagent -l | grep webtop
- Verificare processo: runagent -m webtop1 podman exec CONTAINER pgrep -f catalina


================================================================================
SICUREZZA
================================================================================

CONSIDERAZIONI:
âœ“ Gli script vengono eseguiti come root (richiesto per runagent)
âœ“ Accesso completo a tutti i container e istanze
âœ“ Log di sistema accessibili
âœ“ Script remoti scaricano codice da GitHub - verificare HTTPS

PERMESSI CONSIGLIATI:
- Script in /usr/local/bin/: 755 (rwxr-xr-x)
- Script in /usr/lib/check_mk_agent/local/: 755 (rwxr-xr-x)
- Log /var/log/podman_events.log: 644 (rw-r--r--)

RUNAGENT SECURITY:
runagent esegue comandi con privilegi elevati all'interno delle istanze.
Verificare sempre i comandi eseguiti negli script.


================================================================================
DIFFERENZE NS7 vs NS8
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CARATTERISTICA          â”‚ NETHSERVER 7       â”‚ NETHSERVER 8               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Architettura            â”‚ Monolitica         â”‚ Istanze modulari           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Container Runtime       â”‚ N/A (bare metal)   â”‚ Podman                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Gestione servizi        â”‚ systemctl          â”‚ runagent                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Path script nopolling   â”‚ /usr/lib/.../local/â”‚ /usr/local/bin/            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Path script polling     â”‚ /usr/lib/.../plugi â”‚ /usr/lib/.../local/        â”‚
â”‚                         â”‚ ns/                â”‚                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Mail stack              â”‚ Integrato          â”‚ Container separati         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ WebTop                  â”‚ tomcat8@webtop     â”‚ Container in istanza       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SOS                     â”‚ don (WindMill)     â”‚ NethSecurity Support       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Configurazione          â”‚ config-database    â”‚ config show/setprop        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
AUTORE E LICENZA
================================================================================

Autore:     NethLab / Marzio Project
Repository: https://github.com/Coverup20/checkmk-tools
Licenza:    [Specificare licenza]

CompatibilitÃ  testata:
- NethServer 8 (Podman-based)
- CheckMK Raw 2.4.x

================================================================================
Fine documento
================================================================================
