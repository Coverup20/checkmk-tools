#!/usr/bin/env bash
# Telegram Real IP
set -euo pipefail

# === CONFIG ===
TOKEN="${TELEGRAM_TOKEN:-}"
CHAT_ID="${TELEGRAM_CHAT_ID:-}"

CMK_URL="https://monitor.nethlab.it/monitoring"
SITE="monitoring"
# ==============

get_emoji() {
  case "$1" in
    OK|UP) echo -n "ðŸŸ¢" ;;
    WARN|WARNING) echo -n "ðŸŸ¡" ;;
    CRIT|CRITICAL|DOWN) echo -n "ðŸ”´" ;;
    UNKNOWN) echo -n "âšª" ;;
    *) echo -n "â”" ;;
  esac
}

# URL-encode helper (returns value instead of printing directly)

urlencode() {
  local raw="${1:-}"
  if command -v python3 >/dev/null 2>&1; then
    python3 -c 'import urllib.parse,sys;print(urllib.parse.quote(sys.argv[1]), end="")' "$raw" 2>/dev/null || true
  else
    echo -n "$raw" | sed 's/ /%20/g'
  fi
}

# Se la label real_ip esiste la usiamo, altrimenti cadiamo su NOTIFY_HOSTADDRESS
REAL_IP="${NOTIFY_HOSTLABEL_real_ip:-${NOTIFY_HOSTADDRESS:-}}"

# Costruzione messaggio
if [[ "${NOTIFY_WHAT:-SERVICE}" = "SERVICE" ]]; then
  EMOJI="$(get_emoji "${NOTIFY_SERVICESTATE:-UNKNOWN}")"
  SERVICE_ENC="$(urlencode "${NOTIFY_SERVICEDESC:-SERVICE}")"

  SERVICE_LINK="${CMK_URL}/check_mk/view.py?view_name=service&host=${NOTIFY_HOSTNAME:-}&service=${SERVICE_ENC}&site=${SITE}"
  HOST_LINK="${CMK_URL}/check_mk/view.py?view_name=host&host=${NOTIFY_HOSTNAME:-}&site=${SITE}"

  MSG="[${EMOJI} ${NOTIFY_SERVICESTATE:-UNKNOWN}] Servizio â†’ ${NOTIFY_SERVICEDESC:-}
Host: ${NOTIFY_HOSTNAME:-unknown} (${REAL_IP})
Output: ${NOTIFY_SERVICEOUTPUT:-N/A}"

  BUTTON='{"inline_keyboard":[[{"text":"ðŸ”— Servizio","url":"'"$SERVICE_LINK"'"},{"text":"ðŸ–¥ Host","url":"'"$HOST_LINK"'"}]]}'
else
  EMOJI="$(get_emoji "${NOTIFY_HOSTSTATE:-UNKNOWN}")"
  HOST_LINK="${CMK_URL}/check_mk/view.py?view_name=host&host=${NOTIFY_HOSTNAME:-}&site=${SITE}"

  MSG="[${EMOJI} ${NOTIFY_HOSTSTATE:-UNKNOWN}] Host â†’ ${NOTIFY_HOSTNAME:-unknown}
IP: ${REAL_IP}
Output: ${NOTIFY_HOSTOUTPUT:-N/A}"

  BUTTON='{"inline_keyboard":[[{"text":"ðŸ–¥ Host","url":"'"$HOST_LINK"'"}]]}'
fi

# Prefisso per riconoscere subito la VPS
MSG="âš ï¸ [VPS] âš ï¸ $MSG"

# Invio silenzioso
curl -sS -o /dev/null -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
  -d chat_id="${CHAT_ID}" \
  -d text="$MSG" \
  --data-urlencode "reply_markup=$BUTTON" >/dev/null 2>&1 || true

exit 0

